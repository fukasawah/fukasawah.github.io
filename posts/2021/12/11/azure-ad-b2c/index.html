<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/theme.min.c2192e42f5d8aa9c5c065b0031ed7adc9d457a6b5fa3af342c2e576cdee33bce3ae51be85f1c2356f2270efcea7d867a97195c67f6061e7036c402f41d576f97.css integrity="sha512-whkuQvXYqpxcBlsAMe163J1Femtfo680LC5XbN7jO8465RvoXxwjVvInDvzqfYZ6lxlcZ/YGHnA2xAL0HVdvlw=="><link rel=stylesheet href=https://fukasawah.github.io/css/syntax.min.9d0044b0ce135aff3405271be2a17805c5ae03ec48f146191dc4b30923424c76fe7c6086323aa2cbf83affd41e11fef907f33b6cd685fe3645043bb79f63509a.css integrity="sha512-nQBEsM4TWv80BScb4qF4BcWuA+xI8UYZHcSzCSNCTHb+fGCGMjqiy/g6/9QeEf75B/M7bNaF/jZFBDu3n2NQmg==" media=print onload='this.media="all"'><noscript><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/syntax.min.9d0044b0ce135aff3405271be2a17805c5ae03ec48f146191dc4b30923424c76fe7c6086323aa2cbf83affd41e11fef907f33b6cd685fe3645043bb79f63509a.css integrity="sha512-nQBEsM4TWv80BScb4qF4BcWuA+xI8UYZHcSzCSNCTHb+fGCGMjqiy/g6/9QeEf75B/M7bNaF/jZFBDu3n2NQmg=="></noscript><title>Azure AD B2Cを作ってサンプルアプリを動かした | fukasawah.github.io</title></head><body><header><p><a href=https://fukasawah.github.io/>fukasawah.github.io</a></p></header><main><article><header><h1>Azure AD B2Cを作ってサンプルアプリを動かした</h1></header><aside class=toc><nav id=TableOfContents><ul><li><a href=#参考資料>参考資料</a></li><li><a href=#作成準備>作成準備</a><ul><li><a href=#dnsゾーン作成任意>DNSゾーン作成（任意）</a></li><li><a href=#サブスクリプションにリソースプロバイダを登録する>サブスクリプションにリソースプロバイダを登録する</a></li></ul></li><li><a href=#azure-ad-b2cテナントを作成>Azure AD B2Cテナントを作成</a><ul><li><a href=#azure-ad-b2cのテナントを作る>Azure AD B2Cのテナントを作る</a></li><li><a href=#カスタムドメイン追加>カスタムドメイン追加</a></li></ul></li><li><a href=#azure-ad-b2cで認証させるサンプルアプリを動かす>Azure AD B2Cで認証させるサンプルアプリを動かす</a><ul><li><a href=#ユーザフローを作成する>ユーザフローを作成する</a></li><li><a href=#アプリの登録を行う>アプリの登録を行う</a></li><li><a href=#サンプルアプリの設定に反映>サンプルアプリの設定に反映</a></li><li><a href=#サンプルアプリを動かす>サンプルアプリを動かす</a></li><li><a href=#トラブルシューティング>トラブルシューティング</a></li></ul></li><li><a href=#終わり>終わり</a></li></ul></nav></aside><p>Azure AD B2CでめんどくさいID管理を丸投げできないかなと思い調べた</p><h2 id=参考資料>参考資料</h2><p>ドキュメント</p><ul><li><a href=https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/>https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/</a></li></ul><p>読んでおくと良さそうな記事</p><ul><li><a href=https://jpazureid.github.io/blog/azure-active-directory/azure-ad-b2c-fundamentals/>https://jpazureid.github.io/blog/azure-active-directory/azure-ad-b2c-fundamentals/</a></li><li><a href=https://qiita.com/Shinya-Yamaguchi/items/03321728b373a27be009>https://qiita.com/Shinya-Yamaguchi/items/03321728b373a27be009</a></li></ul><h2 id=作成準備>作成準備</h2><h3 id=dnsゾーン作成任意>DNSゾーン作成（任意）</h3><p>Azure DNSゾーンでやる必要はなく、任意のドメインレジストラで大抵対応できる。今回はなんとなくAzure DNSゾーンを作り委任する。</p><p><figure><a href=images/index/2021-12-11-05-35-16.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-35-16_huc6c01608a6365c5bdd698563898edbc4_51904_500x500_fit_q80_h2_box_3.webp width=500 height=327><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-35-16_huc6c01608a6365c5bdd698563898edbc4_51904_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=327 loading=lazy></picture></a></figure></p><p>DNSゾーンに割り振られたネームサーバを確認</p><p><figure><a href=images/index/2021-12-11-05-38-23.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-38-23_hu434abc0467a88b8845698e3d6daf2b60_41516_500x500_fit_q80_h2_box_3.webp width=500 height=103><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-38-23_hu434abc0467a88b8845698e3d6daf2b60_41516_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=103 loading=lazy></picture></a></figure></p><p>Googleドメインを使っていたので、Azure DNSゾーンのネームサーバを設定し、そちらを見てもらうようにする。</p><p><figure><a href=images/index/2021-12-11-05-41-18.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-41-18_huc4488f5675e11aa958f35daec7109a61_71119_500x500_fit_q80_h2_box_3.webp width=500 height=251><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-41-18_huc4488f5675e11aa958f35daec7109a61_71119_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=251 loading=lazy></picture></a></figure></p><h3 id=サブスクリプションにリソースプロバイダを登録する>サブスクリプションにリソースプロバイダを登録する</h3><p>よくわかってないが予めやっておく必要がある。</p><p>サブスクリプション→リソースプロバイダから<code>Microsoft.AzureActiveDirectory</code>がRegisteredになっていることを確認する。</p><p><figure><a href=images/index/2021-12-11-06-03-32.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-03-32_hu64b40eb1857e06f5107c356d0429552a_46893_500x500_fit_q80_h2_box_3.webp width=500 height=283><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-03-32_hu64b40eb1857e06f5107c356d0429552a_46893_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=283 loading=lazy></picture></a></figure></p><p>NotRegisteredな状態だと作れないので、その時は選択し登録する。</p><h2 id=azure-ad-b2cテナントを作成>Azure AD B2Cテナントを作成</h2><p>Azure AD B2C自体は「サービス」であり、実体は「テナント」と呼ぶ。（オブジェクト指向言語のクラスとインスタンスみたいな感じ。）</p><h3 id=azure-ad-b2cのテナントを作る>Azure AD B2Cのテナントを作る</h3><p>チュートリアルに従って進めた。</p><p><a href=https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/tutorial-create-tenant>https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/tutorial-create-tenant</a></p><p><figure><a href=images/index/2021-12-11-05-58-28.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-58-28_hu1794b7c3e99e520a4c44490d7d942df7_22285_500x500_fit_q80_h2_box_3.webp width=500 height=119><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-58-28_hu1794b7c3e99e520a4c44490d7d942df7_22285_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=119 loading=lazy></picture></a></figure></p><p><figure><a href=images/index/2021-12-11-05-59-10.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-59-10_huf1d3d6ef5c3d3c6fc353082b6228eb0c_25601_500x500_fit_q80_h2_box_3.webp width=500 height=207><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-05-59-10_huf1d3d6ef5c3d3c6fc353082b6228eb0c_25601_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=207 loading=lazy></picture></a></figure></p><p><figure><a href=images/index/2021-12-11-06-00-08.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-00-08_hu1c59ef04f73d46a7c755dd1550825797_39568_500x500_fit_q80_h2_box_3.webp width=500 height=479><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-00-08_hu1c59ef04f73d46a7c755dd1550825797_39568_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=479 loading=lazy></picture></a></figure></p><h3 id=カスタムドメイン追加>カスタムドメイン追加</h3><p>アプリを動かすだけなら無くてもいいのだが、せっかくなのでAzure AD B2Cをカスタムドメインで運用したい。</p><p><a href=https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/custom-domain>https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/custom-domain</a></p><p><code>Azure Active Directory</code> を開く。B2Cのほうではない。</p><p><figure><a href=images/index/2021-12-11-06-16-32.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-16-32_hu92218a54fe7f5faee57edefbdf6b6aa3_8785_500x500_fit_q80_h2_box_3.webp width=426 height=172><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-16-32_hu92218a54fe7f5faee57edefbdf6b6aa3_8785_500x500_fit_q80_bgffffff_box_3.jpg width=426 height=172 loading=lazy></picture></a></figure></p><p>B2Cのものが表示されるはずなので確認する。そうでない場合は、ディレクトリの切り替えを行う。</p><p><figure><a href=images/index/2021-12-11-06-17-19.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-17-19_hu96440c0b79b1fda42ab846477321a331_26078_500x500_fit_q80_h2_box_3.webp width=500 height=288><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-17-19_hu96440c0b79b1fda42ab846477321a331_26078_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=288 loading=lazy></picture></a></figure></p><p>カスタムドメインを追加する。
apexドメイン(fukasawah.dev)でも良いが、今回はアプリケーションをいくつも持つ想定でサブドメイン <code>example.fukasawah.dev</code> としてみる。(テナント名も変えればよかった)</p><p>追加すると、ドメインの持ち主か確認のためレコードを登録する作業が必要。</p><p><figure><a href=images/index/2021-12-11-06-21-33.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-21-33_hu66d3353ca4f7ca8dc6d376ab793c1b62_34897_500x500_fit_q80_h2_box_3.webp width=500 height=349><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-21-33_hu66d3353ca4f7ca8dc6d376ab793c1b62_34897_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=349 loading=lazy></picture></a></figure></p><p>先ほど作ったDNSゾーンにレコードを登録する。apexドメインの場合は<code>@</code>でよいが、今回はサブドメイン<code>example.fukasawah.dev</code>を使っているので、<code>example</code>とする。</p><p><figure><a href=images/index/2021-12-11-06-24-03.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-24-03_hudb69a6c243af35da97b9a2ed97c27c0e_13672_500x500_fit_q80_h2_box_3.webp width=414 height=395><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-24-03_hudb69a6c243af35da97b9a2ed97c27c0e_13672_500x500_fit_q80_bgffffff_box_3.jpg width=414 height=395 loading=lazy></picture></a></figure></p><p>DNSゾーン登録後、確認し、DNSがうまく反映されていれば以下のような画面になる。</p><p><figure><a href=images/index/2021-12-11-06-25-34.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-25-34_hu6eba2802c3f6ff1a55296fba0562fa13_28582_500x500_fit_q80_h2_box_3.webp width=500 height=326><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-25-34_hu6eba2802c3f6ff1a55296fba0562fa13_28582_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=326 loading=lazy></picture></a></figure></p><p>検証後はDNSゾーンのレコードを削除する（もう使わないので）</p><p>カスタムドメインを再度開き、プライマリに変更するのを忘れずに。</p><p><figure><a href=images/index/2021-12-11-06-41-03.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-41-03_hu0377bb02e4c2bbc55a96433e1b899ec9_28297_500x500_fit_q80_h2_box_3.webp width=500 height=295><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-06-41-03_hu0377bb02e4c2bbc55a96433e1b899ec9_28297_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=295 loading=lazy></picture></a></figure></p><h2 id=azure-ad-b2cで認証させるサンプルアプリを動かす>Azure AD B2Cで認証させるサンプルアプリを動かす</h2><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/configure-authentication-sample-web-app?tabs=visual-studio-code">https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/configure-authentication-sample-web-app?tabs=visual-studio-code</a></p><p>ここにサンプルコードがあるので、予めcloneしておく。
それを自分が作ったAzure AD B2Cに連携させてみる。</p><h3 id=ユーザフローを作成する>ユーザフローを作成する</h3><p>ユーザフローは要所（サインイン・サインアップ・パスワードリセット・プロフィール編集）において、認証の仕方や、どの情報を登録できるか、どの情報を返すかをコントロールできる。（こんなに分けて作る意味あるのか？という気もするが）</p><p><a href=https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/add-sign-up-and-sign-in-policy>https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/add-sign-up-and-sign-in-policy</a></p><p><figure><a href=images/index/2021-12-11-07-27-33.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-27-33_hud9b9021810cced6a0ca00f83ab567002_34904_500x500_fit_q80_h2_box_3.webp width=500 height=398><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-27-33_hud9b9021810cced6a0ca00f83ab567002_34904_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=398 loading=lazy></picture></a></figure></p><p>ユーザーフロータイプを選択する。今回はユーザが自分からサインアップ（登録）もできるようにしたいので「サインアップとサインイン」を選ぶ。
サインインのみなら「サインイン」を選ぶ。</p><p><figure><a href=images/index/2021-12-11-09-50-56.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-09-50-56_hu33ba4832b3c352af6a4c8f8e13db26d8_94412_500x500_fit_q80_h2_box_3.webp width=500 height=288><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-09-50-56_hu33ba4832b3c352af6a4c8f8e13db26d8_94412_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=288 loading=lazy></picture></a></figure></p><p>フロー名をつけ適当に項目を埋める。</p><p><figure><a href=images/index/2021-12-11-07-31-24.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-31-24_hu7176163d15edcf7ea92b838025e72673_87887_500x500_fit_q80_h2_box_3.webp width=500 height=473><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-31-24_hu7176163d15edcf7ea92b838025e72673_87887_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=473 loading=lazy></picture></a></figure></p><p>「 ユーザー属性とトークン要求」は、「属性を収集する」がサインアップ時に入力させる項目「要求を返す」がサインイン後にトークンに含めるclaimの情報になる。</p><p><figure><a href=images/index/2021-12-11-07-31-46.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-31-46_hudfa448cf5b6f2751aefddb638402b877_122767_500x500_fit_q80_h2_box_3.webp width=500 height=259><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-31-46_hudfa448cf5b6f2751aefddb638402b877_122767_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=259 loading=lazy></picture></a></figure></p><p>後は必要に応じて作ればよいが、最低限サインインとパスワードリセットの2つは作っておいた方がよさそう。</p><h3 id=アプリの登録を行う>アプリの登録を行う</h3><p>テナントを開き、アプリの登録を行う。</p><p><figure><a href=images/index/2021-12-11-07-12-41.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-12-41_hud0bb8b43b003807aa6e67db94152fc7e_69533_500x500_fit_q80_h2_box_3.webp width=500 height=299><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-12-41_hud0bb8b43b003807aa6e67db94152fc7e_69533_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=299 loading=lazy></picture></a></figure></p><p>「任意の ID プロバイダーまたは組織ディレクトリ内のアカウント (ユーザー フローを使用したユーザーの認証用)」にすること。
このテナントしか使わないからと「この組織ディレクトリのみに含まれるアカウント」を選ぶと、通らなくなるので注意。</p><p>リダイレクトURIは動作確認用アプリに合わせた値を指定する。（サンプルアプリの都合から<code>https://localhost:44316/signin-oidc</code>とした）</p><p><figure><a href=images/index/2021-12-11-08-08-09.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-08-09_hu29c6b7e7e690e01905e23b59aa101980_83258_500x500_fit_q80_h2_box_3.webp width=396 height=500><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-08-09_hu29c6b7e7e690e01905e23b59aa101980_83258_500x500_fit_q80_bgffffff_box_3.jpg width=396 height=500 loading=lazy></picture></a></figure></p><p>認証でIDトークンにチェックする。アクセストークンは渡す必要ないはず。</p><p><figure><a href=images/index/2021-12-11-10-56-56.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-10-56-56_hubbfd6b0dbc45016b4546cf97acabdf2f_95985_500x500_fit_q80_h2_box_3.webp width=500 height=261><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-10-56-56_hubbfd6b0dbc45016b4546cf97acabdf2f_95985_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=261 loading=lazy></picture></a></figure></p><p>クライアントIDは設定に使うのでコピーしておく</p><p><figure><a href=images/index/2021-12-11-07-18-37.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-18-37_hucb426511956255a2028070426b3d541d_27852_500x500_fit_q80_h2_box_3.webp width=500 height=217><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-07-18-37_hucb426511956255a2028070426b3d541d_27852_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=217 loading=lazy></picture></a></figure></p><h3 id=サンプルアプリの設定に反映>サンプルアプリの設定に反映</h3><p>appsettings.jsonの内容を書き換える。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>    <span class=s2>&#34;AzureAdB2C&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Instance&#34;</span><span class=p>:</span> <span class=s2>&#34;https://fukasawahdev.b2clogin.com&#34;</span><span class=p>,</span> <span class=c1>// `初期ドメイン名.b2clogin.com`
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nt>&#34;ClientId&#34;</span><span class=p>:</span> <span class=s2>&#34;*********************&#34;</span><span class=p>,</span> <span class=c1>// アプリの登録で登録したクライアントID(アプリケーションID)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nt>&#34;Domain&#34;</span><span class=p>:</span> <span class=s2>&#34;example.fukasawah.dev&#34;</span><span class=p>,</span> <span class=c1>// Azure AD B2C テナントのドメイン名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nt>&#34;SignedOutCallbackPath&#34;</span><span class=p>:</span> <span class=s2>&#34;/signout/B2C_1_example&#34;</span><span class=p>,</span> <span class=c1>// /signout/サインインのユーザーフロー名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nt>&#34;SignUpSignInPolicyId&#34;</span><span class=p>:</span> <span class=s2>&#34;B2C_1_example&#34;</span> <span class=c1>// /signoutサインインの/ユーザーフロー名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//&#34;ResetPasswordPolicyId&#34;: &#34;b2c_1_reset_password&#34; // パスワードリセットのユーザーフロー名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//&#34;EditProfilePolicyId&#34;: &#34;b2c_1_edit_profile&#34; // プロフィール編集のユーザーフロー名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//&#34;CallbackPath&#34;: &#34;/signin/B2C_1_sign_up_in&#34;  // defaults to /signin-oidc
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span><span class=err>,</span>
</span></span></code></pre></div><p>Instanceの値は、Azure AD B2Cを作成した時の「初期ドメイン名」に使った内容がベースになる模様。
<code>初期ドメイン名.onmicrosoft.com</code>だった場合、<code>初期ドメイン名.b2clogin.com</code>になる。</p><h3 id=サンプルアプリを動かす>サンプルアプリを動かす</h3><pre tabindex=0><code>dotnet run
</code></pre><p>プロジェクト内の設定ファイルのおかげで起動後にブラウザが開くはず。</p><p><figure><a href=images/index/2021-12-11-08-23-03.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-23-03_hu710d682e45145d6edda678746d174506_32544_500x500_fit_q80_h2_box_3.webp width=500 height=397><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-23-03_hu710d682e45145d6edda678746d174506_32544_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=397 loading=lazy></picture></a></figure></p><p>ログイン画面はURLが<code>fukasawahdev.b2clogin.com</code> という形になる。
独自ドメインで見せたい場合は、Azure FrontDoorを入れる必要がある模様。証明書の兼ね合いもあるのでなんらかのリバースプロキシを置くしかない・・・</p><p><a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/custom-domain?pivots=b2c-user-flow">https://docs.microsoft.com/en-us/azure/active-directory-b2c/custom-domain?pivots=b2c-user-flow</a></p><p>「sign up now」からユーザ登録ができる。もしユーザ登録させたくない場合は「ユーザフローポリシー」を「サインイン」で作り、それをアプリの設定に使う。</p><p>メール認証する必要があり、メール認証を終えると登録できる。</p><p><figure><a href=images/index/2021-12-11-08-26-13.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-26-13_hu3d13fc537442ca62083348e51ad63b42_23680_500x500_fit_q80_h2_box_3.webp width=500 height=486><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-26-13_hu3d13fc537442ca62083348e51ad63b42_23680_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=486 loading=lazy></picture></a></figure></p><p>登録後、リダイレクトして戻ってくる。ユーザ情報を取れていることが分かる。</p><p><figure><a href=images/index/2021-12-11-08-27-47.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-27-47_hub699f23933ae542f452ff5cb65d6102a_59308_500x500_fit_q80_h2_box_3.webp width=500 height=303><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-27-47_hub699f23933ae542f452ff5cb65d6102a_59308_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=303 loading=lazy></picture></a></figure></p><p>サンプルアプリではClaimの内容も確認できる（cookieは暗号化されているっぽい？）</p><p><figure><a href=images/index/2021-12-11-08-40-13.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-40-13_huc8f66ec1d55cb256c8e38bcc557f8037_20628_500x500_fit_q80_h2_box_3.webp width=500 height=224><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-40-13_huc8f66ec1d55cb256c8e38bcc557f8037_20628_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=224 loading=lazy></picture></a></figure></p><p>ユーザー登録したので、AD上にもユーザが増えている</p><p><figure><a href=images/index/2021-12-11-09-05-31.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-09-05-31_hu0686de646b4c142b0adda5ce5b9489af_53522_500x500_fit_q80_h2_box_3.webp width=500 height=152><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-09-05-31_hu0686de646b4c142b0adda5ce5b9489af_53522_500x500_fit_q80_bgffffff_box_3.jpg width=500 height=152 loading=lazy></picture></a></figure></p><h3 id=トラブルシューティング>トラブルシューティング</h3><p><figure><a href=images/index/2021-12-11-08-07-13.png target=_blank onclick=showOverlay(event)><picture><source type=image/webp srcset=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-07-13_hu2eed65195904738715da9578aa251af4_16364_500x500_fit_q80_h2_box_3.webp width=498 height=409><img src=/posts/2021/12/11/azure-ad-b2c/images/index/2021-12-11-08-07-13_hu2eed65195904738715da9578aa251af4_16364_500x500_fit_q80_bgffffff_box_3.jpg width=498 height=409 loading=lazy></picture></a></figure></p><pre tabindex=0><code>AADB2C90068: The provided application with ID &#39;クライアントID&#39; is not valid against this service. Please use an application created via the B2C portal and try again.
</code></pre><p>次を見て解決。</p><p><a href=https://docs.microsoft.com/en-us/answers/questions/360401/aadb2c90068-the-provided-application-with-id-is-no.html>https://docs.microsoft.com/en-us/answers/questions/360401/aadb2c90068-the-provided-application-with-id-is-no.html</a></p><p>「アプリを登録」するときに「<strong>任意の ID プロバイダーまたは組織ディレクトリ内のアカウント</strong>」を選ぶ必要があった。
外部のIDプロバイダ使わないし「この組織ディレクトリのみに含まれるアカウント」でよいのでは？と思って選ぶとこれにハマる。</p><h2 id=終わり>終わり</h2><p>これだけなのに4時間ぐらいかかった。</p><p>しかもやっただけで、細かいところはよくわかってない。やることはまだまだありそうだが一旦ここまで。</p><ul><li>ユーザ登録を柔軟に制御したい場合（管理画面などから登録させるとか、招待メールを送るとか、一括登録とか）</li><li>アプリ上のデータの紐づけ方（クレームに含まれるユーザのObjectIDでやっていいのかどうかとか）</li><li>ブランディングの強化<ul><li>ログイン画面の見た目変更（分かる人はMicrosoftのやつじゃんってすぐわかっちゃう）<ul><li>単純なレベルならブランドの設定で出来そう</li><li>より細かくもできるかもしれない？<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/customize-ui-with-html?pivots=b2c-user-flow">https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/customize-ui-with-html?pivots=b2c-user-flow</a></li></ul></li></ul></li><li>日本語化（ブラウザの言語設定をみているかもしれない。が、私の環境は日本語のはずだが英語で出る）</li><li>Azure Frontdoorを使って、カスタムドメインでログイン画面を見せたい。<code>.b2clogin.com</code>というあまり関係ないURLに遷移するとか今どきは怖いはず。</li></ul></li></ul><footer><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://fukasawah.github.io/tags/azure>#Azure</a></span>
<span class=tag><a href=https://fukasawah.github.io/tags/azure-ad-b2c>#Azure AD B2C</a></span></p><p>Created at: 2021-12-11 11:09 +0900<br>Updated at: 2021-12-11 11:13 +0900 <a href=https://github.com/fukasawah/blog/commit/0c2d9b07ea113d1271eba37bd6f98b57fa771881 target=_blank rel=noopener>#0c2d9b0</a></p><p><a href=https://fukasawah.github.io/posts/2022/03/02/workspace-base-appinsights-with-arm-template/><span title="ワークスペースベースの Application Insights の移行をARM Templateで試した">&lt; Next</span></a>
|
<a href=https://fukasawah.github.io/posts/><span title=Posts>Posts</span></a>
|
<a href=https://fukasawah.github.io/posts/2021/12/05/exam-az-104/><span title=MCP資格のAZ-104に合格しました>Prev ></span></a></p></footer></article><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//fukasawah.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
<script src=https://fukasawah.github.io/js/theme-posts.min.526bf4c8dff80bed936c62a06f7bc8c02703fad621e3dd2ba243812d43c40b98397ff1951e5905c790b97c38633d42a0e35bf5314fdf9fcfbce31b18181b8ae3.js integrity="sha512-Umv0yN/4C+2TbGKgb3vIwCcD+tYh490rokOBLUPEC5g5f/GVHlkFx5C5fDhjPUKg41v1MU/fn8+84xsYGBuK4w==" defer></script></main><footer><p>&copy; 2023 <a href=https://fukasawah.github.io/>fukasawah</a></p></footer></body></html>