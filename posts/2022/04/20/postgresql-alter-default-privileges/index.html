<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/theme.min.9d12c4e634f802b98375ad90880492251ec9d3f73bc320dab9d903811246e0b42c708c1a8d50717f9b1babc9feb6efa75bb5d414cf501a45ec86f4d77731b4a9.css integrity="sha512-nRLE5jT4ArmDda2QiASSJR7J0/c7wyDaudkDgRJG4LQscIwajVBxf5sbq8n+tu+nW7XUFM9QGkXshvTXdzG0qQ=="><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/syntax.min.9d0044b0ce135aff3405271be2a17805c5ae03ec48f146191dc4b30923424c76fe7c6086323aa2cbf83affd41e11fef907f33b6cd685fe3645043bb79f63509a.css integrity="sha512-nQBEsM4TWv80BScb4qF4BcWuA+xI8UYZHcSzCSNCTHb+fGCGMjqiy/g6/9QeEf75B/M7bNaF/jZFBDu3n2NQmg=="><title>fukasawah.github.io | PostgreSQLのALTER DEFAULT PRIVILEGESのtarget_roleには指定したロール自身の操作しか反映されない</title></head><body><header><p><a href=https://fukasawah.github.io/>fukasawah.github.io</a></p></header><main><article><header><h1>PostgreSQLのALTER DEFAULT PRIVILEGESのtarget_roleには指定したロール自身の操作しか反映されない</h1></header><aside class=toc><nav id=TableOfContents><ul><li><a href=#要約>要約</a></li><li><a href=#参考>参考</a></li><li><a href=#メモ>メモ</a></li><li><a href=#検証コード>検証コード</a></li></ul></nav></aside><p>タイトル通り。ハマったのでメモ。</p><h2 id=要約>要約</h2><p>テーブル作成ができる <code>contributor</code>というロールがあり、<code>contributor</code>が付与されている<code>admin1</code>というユーザ(ログインできるロール)が居るとする。</p><p>読み取りのみできる<code>reader</code>というロールがあるとする。</p><p>そして、<code>admin1</code>でログインしてpublicスキーマへのテーブル作成で、デフォルトでreaderにSELECTの権限を与えたい場合、<code>SuperUser属性を持つユーザ</code>か<code>admin1</code>でログインして以下のSQLを実行する。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>PRIVILEGES</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>ROLE</span><span class=w> </span><span class=n>admin1</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=k>GRANT</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>TABLES</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>reader</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><code>FOR ROLE admin1</code>のように、実際にログインして作業できるロール(ユーザ)を指定するのが重要で、<code>FOR ROLE contributor</code>とするとダメ。
該当のロール(<code>contributor</code>)が付与されているユーザ(<code>admin1</code>)だからといって、このALTER DEFAULT PRIVILEGESは反映されない。そのため、<code>reader</code>権限が読み取れないテーブルになってしまう。</p><p>なお、<code>FOR ROLE</code>を指定するにはSuperUser属性を持つユーザか、スキーマ(上記の例だとpublic)にCREATEを持つユーザ(<code>admin1</code>)で実行する必要がある。</p><p>テーブルを作成できるユーザ==デフォルト権限を持つユーザ、であれば何の問題もないが、<code>テーブルを作成できるロールのメンバ</code>として管理している場合はこの動きに注意が必要かもしれない。
そうしないと「テーブルを作ったのに権限が付与されない。デフォルト権限はあるのに。なぜだ？」と混乱するだろう。</p><p>（DBの運用上、複数ユーザでテーブルを作ったりすることはほとんどないので、そういったロールをわざわざ作ってユーザに割り当てるようなことはしないか？）</p><h2 id=参考>参考</h2><p><a href=https://www.postgresql.jp/document/11/html/sql-alterdefaultprivileges.html>https://www.postgresql.jp/document/11/html/sql-alterdefaultprivileges.html</a></p><p><code>target_role</code>が今回ポイントの箇所だが、この件に触れられていない気がする。</p><h2 id=メモ>メモ</h2><p><code>FOR ROLE xxx</code>は省略でき、省略した場合は現在作業しているユーザとなる。</p><p><code>TO xxx</code>で指定できるロールは割り当て用のロール(<code>reader</code>)でも、そのロールが割り当てられているユーザでも機能する。</p><p><code>psql</code>では<code>\ddp</code>でデフォルト権限の付与状況を確認できる。<code>\dp</code>でテーブルの権限の状況を確認できる。</p><h2 id=検証コード>検証コード</h2><p>TODO: 出来れば書く。</p><footer><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://fukasawah.github.io/tags/postgresql>#PostgreSQL</a></span></p><p>Created at: 2022-04-20 03:50 +0900<br>Updated at: 2022-04-20 03:50 +0900 <a href=https://github.com/fukasawah/blog/commit/b4c54a66eeb4523154e3403a48508715383bef2a target=_blank rel=noopener>#b4c54a6</a></p><p><a href=https://fukasawah.github.io/posts/2022/09/19/exam-az-204/><span title=MCP資格のAZ-204に合格しました>&lt; Next</span></a>
|
<a href=https://fukasawah.github.io/posts/><span title=Posts>Posts</span></a>
|
<a href=https://fukasawah.github.io/posts/2022/03/02/workspace-base-appinsights-with-arm-template/><span title="ワークスペースベースの Application Insights の移行をARM Templateで試した">Prev ></span></a></p></footer></article><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//fukasawah.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
<script src=https://fukasawah.github.io/js/theme-posts.min.526bf4c8dff80bed936c62a06f7bc8c02703fad621e3dd2ba243812d43c40b98397ff1951e5905c790b97c38633d42a0e35bf5314fdf9fcfbce31b18181b8ae3.js integrity="sha512-Umv0yN/4C+2TbGKgb3vIwCcD+tYh490rokOBLUPEC5g5f/GVHlkFx5C5fDhjPUKg41v1MU/fn8+84xsYGBuK4w==" defer></script></main><footer><p>&copy; 2022 <a href=https://fukasawah.github.io/>fukasawah</a></p></footer></body></html>