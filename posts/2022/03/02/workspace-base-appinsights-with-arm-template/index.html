<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/theme.min.9d12c4e634f802b98375ad90880492251ec9d3f73bc320dab9d903811246e0b42c708c1a8d50717f9b1babc9feb6efa75bb5d414cf501a45ec86f4d77731b4a9.css integrity="sha512-nRLE5jT4ArmDda2QiASSJR7J0/c7wyDaudkDgRJG4LQscIwajVBxf5sbq8n+tu+nW7XUFM9QGkXshvTXdzG0qQ=="><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/syntax.min.9d0044b0ce135aff3405271be2a17805c5ae03ec48f146191dc4b30923424c76fe7c6086323aa2cbf83affd41e11fef907f33b6cd685fe3645043bb79f63509a.css integrity="sha512-nQBEsM4TWv80BScb4qF4BcWuA+xI8UYZHcSzCSNCTHb+fGCGMjqiy/g6/9QeEf75B/M7bNaF/jZFBDu3n2NQmg=="><title>fukasawah.github.io | ワークスペースベースの Application Insights の移行をARM Templateで試した</title></head><body><header><p><a href=https://fukasawah.github.io/>fukasawah.github.io</a></p></header><main><article><header><h1>ワークスペースベースの Application Insights の移行をARM Templateで試した</h1></header><aside class=toc><nav id=TableOfContents><ul><li><a href=#参考>参考</a></li><li><a href=#きっかけ>きっかけ</a></li><li><a href=#arm-templateで定義する場合>ARM Templateで定義する場合</a></li></ul></nav></aside><p>ワークスペースベースの Application Insightsの移行についてARM Templateで試した。</p><p>ちなみに、Azure Functionなどを画面でポチポチ作るときに作られるApplication Insightsはワークスペースベースになっていないです。</p><p>やるだけなので難しいことはないです。画面からやるのが一番簡単です。</p><p>ARM Template(bicep)でどう書けばいいか、と、画面で行った場合はデータも移行されるが、ARM Templateでは移行されるかを調べたので書いた次第。</p><h2 id=参考>参考</h2><ul><li><a href=https://docs.microsoft.com/ja-jp/azure/azure-monitor/app/create-workspace-resource>ワークスペース ベースの Application Insights リソース - Microsoft docs</a></li><li><a href=https://blog.shibayan.jp/entry/20200928/1601229167>既存の Application Insights を Workspace ベースに移行した - しばやん雑記</a></li></ul><h2 id=きっかけ>きっかけ</h2><p>細かいことはドキュメントに書いてある通りで、ワークスペースを用意する必要がある以外のデメリットはあまりなさそうです。メリットもいくらかはあるようですが、大半はどうでもよかったです。</p><p>ただ、Application Insightsに反映されるまでに5分ぐらい時間がかかる問題があり、これがだいぶストレスでした。shibayan先生のblogを眺めていたところ、ここが改善されたというので試しました。</p><p>結果としては2分弱ぐらいで反映されるようになりだいぶ良くなりました。</p><h2 id=arm-templateで定義する場合>ARM Templateで定義する場合</h2><p>移行前後でApplication Insights周りのリソースの変化を調べた。</p><p><code>microsoft.insights/components</code>(Application Insightsリソース)のpropertiesの設定で</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>    <span class=s2>&#34;IngestionMode&#34;</span><span class=err>:</span> <span class=s2>&#34;ApplicationInsights&#34;</span>
</span></span></code></pre></div><p>これが以下のようになった。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>    <span class=s2>&#34;WorkspaceResourceId&#34;</span><span class=err>:</span> <span class=s2>&#34;LogAnalytics WorkspaceのリソースID&#34;</span><span class=err>,</span> <span class=c1>// 追加
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s2>&#34;IngestionMode&#34;</span><span class=err>:</span> <span class=s2>&#34;LogAnalytics&#34;</span><span class=err>,</span> <span class=c1>// 変更
</span></span></span></code></pre></div><p>この内容を基にBicepで書き直して、既存のリソースに対して適用してみた。
（LogAnalytics Workspaceのリソースは別途、新規で作成。）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bicep data-lang=bicep><span class=line><span class=cl><span class=kd>param</span><span class=w> </span>serviceName<span class=w> </span><span class=nf>string</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=err>&#34;</span>foo<span class=err>&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>param</span><span class=w> </span>environmentName<span class=w> </span><span class=nf>string</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=err>&#34;</span>prd<span class=err>&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>param</span><span class=w> </span>location<span class=w> </span><span class=nf>string</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>resourceGroup</span><span class=p>().</span>location<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>resource</span><span class=w> </span>logAnalytics<span class=w> </span><span class=s>&#39;Microsoft.OperationalInsights/workspaces@2021-06-01&#39;</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=py>name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;lg-${serviceName}-${environmentName}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=py>location</span><span class=p>:</span><span class=w> </span>location<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=py>properties</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>sku</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=py>name</span><span class=p>:</span><span class=w> </span><span class=si>&#39;PerGB2018&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>retentionInDays</span><span class=p>:</span><span class=w> </span>90<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>features</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=py>enableLogAccessUsingOnlyResourcePermissions</span><span class=p>:</span><span class=w> </span>true<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>workspaceCapping</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=py>dailyQuotaGb</span><span class=p>:</span><span class=w> </span>1<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>publicNetworkAccessForIngestion</span><span class=p>:</span><span class=w> </span><span class=si>&#39;Enabled&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>publicNetworkAccessForQuery</span><span class=p>:</span><span class=w> </span><span class=si>&#39;Enabled&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>resource</span><span class=w> </span>appinsights<span class=w> </span><span class=s>&#39;Microsoft.Insights/components@2020-02-02&#39;</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=py>name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;appinsight-${serviceName}-${environmentName}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=py>location</span><span class=p>:</span><span class=w> </span>location<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=py>kind</span><span class=p>:</span><span class=w> </span><span class=si>&#39;web&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=py>properties</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>WorkspaceResourceId</span><span class=p>:</span><span class=w> </span>logAnalytics<span class=p>.</span>id<span class=w> </span><span class=c1>// 追加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>IngestionMode</span><span class=p>:</span><span class=w> </span><span class=si>&#39;LogAnalytics&#39;</span><span class=w>        </span><span class=c1>// 変更</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>Application_Type</span><span class=p>:</span><span class=w> </span><span class=si>&#39;web&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>Flow_Type</span><span class=p>:</span><span class=w> </span><span class=si>&#39;Bluefield&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=py>Request_Source</span><span class=p>:</span><span class=w> </span><span class=si>&#39;rest&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>既存のデータも用意したLogAnalyticsへと移行されました。（ただ２～３日程度のログなので長期間の場合はよくわからない）</p><footer><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://fukasawah.github.io/tags/azure>#Azure</a></span>
<span class=tag><a href=https://fukasawah.github.io/tags/application-insights>#Application Insights</a></span>
<span class=tag><a href=https://fukasawah.github.io/tags/arm-template>#ARM Template</a></span></p><p>Created at: 2022-03-02 02:04 +0900<br>Updated at: 2022-03-02 02:04 +0900 <a href=https://github.com/fukasawah/blog/commit/ca308a041a43a5f1a9653fc950f094560c8a486c target=_blank rel=noopener>#ca308a0</a></p><p><a href=https://fukasawah.github.io/posts/2022/04/20/postgresql-alter-default-privileges/><span title="PostgreSQLのALTER DEFAULT PRIVILEGESのtarget_roleには指定したロール自身の操作しか反映されない">&lt; Next</span></a>
|
<a href=https://fukasawah.github.io/posts/><span title=Posts>Posts</span></a>
|
<a href=https://fukasawah.github.io/posts/2021/12/11/azure-ad-b2c/><span title="Azure AD B2Cを作ってサンプルアプリを動かした">Prev ></span></a></p></footer></article><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//fukasawah.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
<script src=https://fukasawah.github.io/js/theme-posts.min.526bf4c8dff80bed936c62a06f7bc8c02703fad621e3dd2ba243812d43c40b98397ff1951e5905c790b97c38633d42a0e35bf5314fdf9fcfbce31b18181b8ae3.js integrity="sha512-Umv0yN/4C+2TbGKgb3vIwCcD+tYh490rokOBLUPEC5g5f/GVHlkFx5C5fDhjPUKg41v1MU/fn8+84xsYGBuK4w==" defer></script></main><footer><p>&copy; 2022 <a href=https://fukasawah.github.io/>fukasawah</a></p></footer></body></html>