<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/theme.min.95e92366236e3eeadc2635f8c1c7b97ec3640de0147fa10ee1d281d56d40ee1aeb2c76977676599f543a2a682fd96d8cb9633a4fc700e537e46f8ba9d58df9f2.css integrity="sha512-lekjZiNuPurcJjX4wce5fsNkDeAUf6EO4dKB1W1A7hrrLHaXdnZZn1Q6Kmgv2W2MuWM6T8cA5Tfkb4up1Y358g=="><link rel=stylesheet href=https://fukasawah.github.io/css/syntax.min.9d0044b0ce135aff3405271be2a17805c5ae03ec48f146191dc4b30923424c76fe7c6086323aa2cbf83affd41e11fef907f33b6cd685fe3645043bb79f63509a.css integrity="sha512-nQBEsM4TWv80BScb4qF4BcWuA+xI8UYZHcSzCSNCTHb+fGCGMjqiy/g6/9QeEf75B/M7bNaF/jZFBDu3n2NQmg==" media=print onload='this.media="all"'><noscript><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/syntax.min.9d0044b0ce135aff3405271be2a17805c5ae03ec48f146191dc4b30923424c76fe7c6086323aa2cbf83affd41e11fef907f33b6cd685fe3645043bb79f63509a.css integrity="sha512-nQBEsM4TWv80BScb4qF4BcWuA+xI8UYZHcSzCSNCTHb+fGCGMjqiy/g6/9QeEf75B/M7bNaF/jZFBDu3n2NQmg=="></noscript><title>VPS Serverã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨LetsEncryptã«ã‚ˆã‚‹è¨¼æ˜æ›¸å–å¾—ã¨åˆ©ç”¨ã¾ã§(Google Cloud DNS Service) | fukasawah.github.io</title></head><body><header><p><a href=https://fukasawah.github.io/>fukasawah.github.io</a></p></header><main><article><header><h1>VPS Serverã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨LetsEncryptã«ã‚ˆã‚‹è¨¼æ˜æ›¸å–å¾—ã¨åˆ©ç”¨ã¾ã§(Google Cloud DNS Service)</h1></header><p>ã¾ãšã¯å…¥ã£ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é©å½“ã«æœ€æ–°åŒ–</p><pre tabindex=0><code>yum update
reboot
</code></pre><p>ãƒ¦ãƒ¼ã‚¶ã‚’ä½œã‚‹</p><pre tabindex=0><code># ãƒ¦ãƒ¼ã‚¶ä½œæˆ
useradd fukasawah
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
passwd fukasawah

# wheelã‚’ä¸ãˆã¦sudoã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
usermod -G wheel fukasawah
id fukasawah

# ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã«å¤‰æ›´
su - fukasawah

# sudoãŒä½¿ãˆã‚‹ã‹ç¢ºèªã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã—ãŸæ™‚ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦
sudo ls -l /
</code></pre><h3 id=sshéµã®ç”Ÿæˆ>SSHéµã®ç”Ÿæˆ</h3><p>ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã«å¯¾ã—ã¦è¡Œã†ã€‚æ—¢ã«å…¬é–‹éµã®æº–å‚™ãŒã‚ã‚‹å ´åˆã¯ã€å¾Œè¿°ã®authorized_keysã«è¿½è¨˜ã™ã‚‹æ‰‹é †ã¾ã§é£›ã°ã™ã€‚</p><pre tabindex=0><code>$ ssh-keygen -t rsa -b 4096
Generating public/private rsa key pair.
Enter file in which to save the key (/home/fukasawah/.ssh/id_rsa):
Created directory &#39;/home/fukasawah/.ssh&#39;.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/fukasawah/.ssh/id_rsa.
Your public key has been saved in /home/fukasawah/.ssh/id_rsa.pub.
The key fingerprint is:
1c:03:30:bb:05:59:23ğŸ‡©ğŸ‡ª96:02:5a:5b:b2:48:c9:e9 fukasawah@ik1-309-14734.vs.sakura.ne.jp
The key&#39;s randomart image is:
+--[ RSA 4096]----+
|..* *++          |
|.B B.* +         |
|+ o + = o        |
| E   = . o       |
|    .   S        |
|                 |
|                 |
|                 |
|                 |
+-----------------+
</code></pre><p>ä¿¡é ¼ã§ãã‚‹å…¬é–‹éµã¨ã—ã¦ç™»éŒ²ã—ã¦ãŠã</p><pre tabindex=0><code>cat .ssh/id_rsa.pub &gt;&gt; .ssh/authorized_keys
chmod 0600 .ssh/authorized_keys
</code></pre><p>ç§˜å¯†éµã¯SSHæ¥ç¶šæ™‚ã«å¿…è¦ã«ãªã‚‹ã®ã§å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ‰‹å…ƒã«æŒã£ã¦ãã¦ãŠã</p><pre tabindex=0><code>cat .ssh/id_rsa
</code></pre><p>è¡¨ç¤ºã•ã‚ŒãŸ <code>-----BEGIN RSA PRIVATE KEY-----</code>ã‹ã‚‰<code>-----END RSA PRIVATE KEY-----</code>ã¾ã§ã®é–“ã®å†…å®¹ãŒç§˜å¯†éµãªã®ã§ã€ã“ã‚Œã‚’SSHæ¥ç¶šã—ãŸã„ç«¯æœ«ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚</p><p>ä»¥é™ã¯å¿…è¦ãªã„ã®ã§å‰Šé™¤ã—ã¦ãŠã</p><h3 id=sshã‚µãƒ¼ãƒã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’é«˜ã‚ã‚‹>SSHã‚µãƒ¼ãƒã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’é«˜ã‚ã‚‹</h3><p>rootãƒ¦ãƒ¼ã‚¶ã§è¡Œã†ã€‚</p><p>SSHã‚µãƒ¼ãƒã«ä»¥ä¸‹ã®è¨­å®šã‚’æ–½ã™ã€‚</p><ul><li>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’ç„¡åŠ¹ï¼ˆå…¬é–‹éµèªè¨¼ï¼‰</li><li>rootã®ãƒ­ã‚°ã‚¤ãƒ³ç„¡åŠ¹ï¼ˆä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã‹ã‚‰suã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ï¼‰</li><li>ç©ºã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ã‚°ã‚¤ãƒ³ã‚’ç„¡åŠ¹ï¼ˆå¿…ãšãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã—ãªã„ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰</li></ul><pre tabindex=0><code>cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
vi /etc/ssh/sshd_config
</code></pre><p>diffã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã®å·®åˆ†ã‚’å‡ºã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª</p><pre tabindex=0><code>#diff /etc/ssh/sshd_config.bak /etc/ssh/sshd_config
55c55
&lt; #PubkeyAuthentication yes
---
&gt; PubkeyAuthentication yes
78,79c78,79
&lt; #PermitEmptyPasswords no
&lt; PasswordAuthentication yes
---
&gt; PermitEmptyPasswords no
&gt; PasswordAuthentication no
</code></pre><pre tabindex=0><code>å•é¡ŒãŒãªã‘ã‚Œã°sshdã‚’å†èµ·å‹•
systemctl restart sshd
</code></pre><p>ä»¥ä¸‹ã‚’ç¢ºèªã™ã‚‹</p><ul><li>rootï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã“ã¨</li><li>ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã“ã¨</li><li>ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ï¼‹å…¬é–‹éµèªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã“ã¨</li></ul><h3 id=ãƒ­ã‚±ãƒ¼ãƒ«ã¨ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å¤‰æ›´>ãƒ­ã‚±ãƒ¼ãƒ«ã¨ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å¤‰æ›´</h3><p>OSè¨­å®šã®ãƒ­ã‚±ãƒ¼ãƒ«ã¨ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ—¥æœ¬ã«åˆã‚ã›ã‚‹</p><pre tabindex=0><code># ãƒ­ã‚±ãƒ¼ãƒ«ã®ç¢ºèª
locale
# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®ç¢ºèª
date
</code></pre><p>ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å¤‰æ›´ã™ã‚‹ã€‚</p><pre tabindex=0><code># ãƒ­ã‚±ãƒ¼ãƒ«å¤‰æ›´
sudo localectl set-locale LANG=ja_JP.UTF-8

# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›´
sudo timedatectl set-timezone Asia/Tokyo
</code></pre><p>ãƒ­ã‚±ãƒ¼ãƒ«ã¯å†æ¥ç¶šå¾Œã«åæ˜ ã•ã‚Œã‚‹ã€‚</p><pre tabindex=0><code># ãƒ­ã‚±ãƒ¼ãƒ«ã®ç¢ºèª
locale
# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å¤‰æ›´ã®ç¢ºèª
date
</code></pre><h2 id=lets-encryptã§sslè¨¼æ˜æ›¸ã‚’ä½œã‚‹>Let&rsquo;s Encryptã§SSLè¨¼æ˜æ›¸ã‚’ä½œã‚‹</h2><p>ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ Google Domainsã§ç®¡ç†ã—ã¦ãŠã‚Šã€ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ãŸã„ã€‚</p><p>ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰è¨¼æ˜æ›¸ã®å ´åˆã€DNS-01èªè¨¼ãŒå¿…é ˆã§ã‚ã‚ŠDNSã‚µãƒ¼ãƒã«å¯¾ã—ã¦TXTãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚‹ã€‚
ä¸€èˆ¬çš„ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¸ã‚¹ãƒˆãƒªï¼ˆãŠåå‰.comã€Value-Domainç­‰ï¼‰ã§ã‚‚æ‰‹å‹•ã§è¡Œãˆã°å¯èƒ½ã§ã¯ã‚ã‚‹ãŒã€90æ—¥ã®æœ‰åŠ¹æœŸé–“ã—ã‹ãªã„ãŸã‚ã€ã“ã®ä½œæ¥­ã¯è‡ªå‹•åŒ–ã—ãŸã„ã€‚</p><p>ã‚‚ã¡ã‚ã‚“ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãªã©ã‚’é§†ä½¿ã™ã‚Œã°å‡ºæ¥ãªãã¯ãªã„ãŒãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´ãªã©ã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå‹•ã‹ãªããªã‚‹ãƒªã‚¹ã‚¯ã‚‚è€ƒãˆã‚‰ã‚Œã‚‹ã€‚ãã®ã‚ãŸã‚Šã‚’è€ƒãˆã‚‹ã¨å¤§å¤‰ã€‚
ãã“ã§ã€DNSã‚’APIã§æ“ä½œã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã€‚ã“ã¡ã‚‰ãªã‚‰APIãŒå¤‰ã‚ã‚‰ãªã„é™ã‚Šå‹•ã‹ãªããªã‚‹ã“ã¨ã‚‚ãªãã€å¤±æ•—æ™‚ã®å‹•ä½œã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã€‚</p><p>ãŸã ã€ãã®ãŸã‚ã«ã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã§ã¯ãªãã€ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã«è»¢é€ã—ã€è§£æ±ºã•ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹</p><p>ä»Šå›ã¯Coocle Cloud Platformã§æä¾›ã•ã‚Œã¦ã„ã‚‹Google Cloud DNS Serviceã‚’ä½¿ã†ã€‚ã¡ãªã¿ã«ã€Azure DNSã§ã‚‚åŒã˜è¦é ˜ã§å‡ºæ¥ã‚‹ã€‚
LetsEncryptã«ã‚ˆã‚‹è¨¼æ˜æ›¸ã®ä½œæˆãƒ»æ›´æ–°ã‚’è¡Œã†ãŸã‚ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã¯ã€certbot+certbot-dns-google ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã†ã€‚</p><ul><li>Google Cloud DNS Serviceã¸ã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹</li><li>ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã‚’å¤‰æ›´(Google domains -> Google Cloud DNS Service)</li><li>Google Cloud DNS Serviceã®èªå¯æƒ…å ±ã‚’ä½œã‚‹</li></ul><h3 id=google-cloud-dns-serviceã¸ã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹>Google Cloud DNS Serviceã¸ã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹</h3><p><a href=https://cloud.google.com/dns/>https://cloud.google.com/dns/</a></p><p>ã‚¾ãƒ¼ãƒ³ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã—ã¦DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç®¡ç†ã™ã‚‹å˜ä½ã§ã€1ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã¤ã1ã‚¾ãƒ¼ãƒ³ã‚’ä½œã‚‹ã“ã¨ã«ãªã‚‹ã€‚</p><p>ä»¥ä¸‹ã‚’é€²ã‚ã¦ã€Google Cloud DNS Serviceã‚’æœ‰åŠ¹åŒ–ã«ã™ã‚‹ã€‚</p><p><a href=https://console.cloud.google.com/net-services/dns/zones>https://console.cloud.google.com/net-services/dns/zones</a></p><p>ã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚</p><ul><li>ã‚¾ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—: å…¬é–‹</li><li>ã‚¾ãƒ¼ãƒ³å: è‡ªç”±</li><li>DNSå: å–å¾—ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³å</li><li>DNSSEC: ã‚ªãƒ³</li></ul><p><figure><img src=/images/vps-server-setup-with-letsencrypt/2019-03-16-21-14-23.png loading=lazy></figure></p><p>ä½œæˆå‡ºæ¥ãŸã‚‰ã‚¾ãƒ¼ãƒ³ã«ã¤ã„ã¦ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãŒå‰²ã‚Šå½“ãŸã‚‹ã€‚ã‚¾ãƒ¼ãƒ³ã§ç™»éŒ²ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã®æƒ…å ±ã¯ã“ã®ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã«è¨­å®šã•ã‚Œã‚‹ã€‚</p><h3 id=ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã‚’å¤‰æ›´google-domains---google-cloud-dns-service>ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã‚’å¤‰æ›´(Google domains -> Google Cloud DNS Service)</h3><p>Google Cloud DNS Serviceã§ã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆã—ãŸæ™‚ã«å¾—ã‚‰ã‚ŒãŸãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã‚’Google Domainsã«ç™»éŒ²ã™ã‚‹ã€‚</p><p>ã¾ãšã€<a href=https://domains.google.com/>Google Domains</a>ã‚’é–‹ãã€ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã‚’å¤‰æ›´ã™ã‚‹ã€‚</p><p><figure><img src=/images/vps-server-setup-with-letsencrypt/2019-03-16-21-20-14.png loading=lazy></figure></p><p>ã“ã®å¤‰æ›´ã¯æœ€é•·1æ—¥ãã‚‰ã„ã‹ã‹ã‚‹ã€‚çµæ§‹æ™‚é–“ãŒã‹ã‹ã£ãŸã€‚</p><h3 id=google-cloud-dns-serviceã®èªå¯æƒ…å ±ã‚’ä½œã‚‹>Google Cloud DNS Serviceã®èªå¯æƒ…å ±ã‚’ä½œã‚‹</h3><p>æ¬¡ã«Google DNSã§DNSç™»éŒ²ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒè¡Œãˆã‚‹ã‚ˆã†ã«OAuth2èªè¨¼ã®æº–å‚™ã‚’ã™ã‚‹</p><p><a href=https://developers.google.com/identity/protocols/OAuth2ServiceAccount#creatinganaccount>https://developers.google.com/identity/protocols/OAuth2ServiceAccount#creatinganaccount</a></p><ul><li>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹(fukasawah-devã¨ã—ãŸ)</li><li>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹ï¼ˆcertbotã¨ã—ãŸï¼‰</li><li>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™ã‚’è¨­å®šã™ã‚‹ï¼ˆDNSç®¡ç†è€…ã¨ã—ãŸã€‚ãŠãã‚‰ãã“ã‚ŒãŒå¿…è¦æœ€å°é™ã®æ¨©é™ï¼‰</li><li>ã‚­ãƒ¼ã®ä½œæˆã‚’è¡Œã„ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã§å‡ºåŠ›ã™ã‚‹ã€‚ã“ã‚ŒãŒã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«æƒ…å ±ã¨ãªã‚‹ã€‚</li></ul><p>ã“ã“ã§ç”Ÿæˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã®å¾Œä½¿ã†ã€‚</p><p>ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«æƒ…å ±ã¯è‡ªåˆ†ã®ä»£ã‚ã‚Šã«æ“ä½œã‚’è¨±ã™ãŸã‚ã®èªè¨¼æƒ…å ±ã¨ã„ã†æ‰±ã„ãªã®ã§ã€çµ¶å¯¾ã«äººã«è¦‹ã›ã¦ã¯ã„ã‘ãªã„ã€‚
ã¾ãŸã€ã‚‚ã—æ¼ã‚ŒãŸå ´åˆã§ã‚‚å½±éŸ¿ã‚’æŠ‘ãˆã‚‹ãŸã‚ã€æ¨©é™ã¯å¿…è¦æœ€å°é™ã«è¨­å®šã™ã‚‹ã€‚</p><h3 id=certbotã§sslè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹>certbotã§SSLè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹</h3><p><a href=https://docs.docker.com/install/linux/docker-ce/centos/>https://docs.docker.com/install/linux/docker-ce/centos/</a></p><p>ä»Šå›ã¯dockerã¨certbotã‚’ä½¿ã†ã€‚dockerã®ã»ã†ãŒç’°å¢ƒãŒæ±šã‚Œãªãã¦ç²¾ç¥è¡›ç”Ÿä¸Šã‚ˆã„ãŸã‚ã€‚</p><pre tabindex=0><code>yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum install docker-ce docker-ce-cli containerd.io

systemctl start docker
systemctl enable docker
</code></pre><p>dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒçµ‚ã‚ã£ãŸã‚‰ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç”¨æ„ã™ã‚‹</p><pre tabindex=0><code>groupadd letsencrypt
mkdir -p /etc/letsencrypt /var/lib/letsencrypt /var/log/letsencrypt
chmod 0770 /etc/letsencrypt /var/lib/letsencrypt /var/log/letsencrypt
chown root:letsencrypt /etc/letsencrypt /var/lib/letsencrypt /var/log/letsencrypt
</code></pre><p>å®Ÿè¡Œå‰ã«Google Cloud DNSã‚’æ“ä½œã™ã‚‹ãŸã‚ã®èªè¨¼æƒ…å ±ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ä¸ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€å…ˆã»ã©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ã‚‹ã€‚</p><pre tabindex=0><code>vi /etc/letsencrypt/google.json
chmod 0600 /etc/letsencrypt/google.json
</code></pre><p>ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ã‚ˆã—ãªã«ç½®ãæ›ãˆã‚‹</p><pre tabindex=0><code>sudo docker run -it --rm --name certbot \
            -v &#34;/etc/letsencrypt:/etc/letsencrypt&#34; \
            -v &#34;/var/lib/letsencrypt:/var/lib/letsencrypt&#34; \
            -v &#34;/var/log/letsencrypt:/var/log/letsencrypt&#34; \
            certbot/dns-google certonly \
  --dns-google \
  --dns-google-credentials /etc/letsencrypt/google.json \
  --dns-google-propagation-seconds 120 \
  -d fukasawah.dev \
  -d *.fukasawah.dev
</code></pre><p>å®Ÿè¡Œã™ã‚‹ã¨3ã¤ã»ã©å°‹ã­ã‚‰ã‚Œã‚‹ã€‚</p><ul><li>å†ç™ºè¡Œã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é€šçŸ¥å…ˆã®Email</li><li>åˆ©ç”¨è¦ç´„ã¨ãã®åŒæ„</li><li>éå–¶åˆ©çµ„ç¹”Electronic Frontier Foundationã®æ´»å‹•ã‚’ä¼ãˆã‚‹ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…±æœ‰ã—ã¦ã‚ˆã„ã‹ï¼Ÿï¼ˆNoã§ã‚ˆã„ï¼‰</li></ul><pre tabindex=0><code>Enter email address (used for urgent renewal and security notices) (Enter &#39;c&#39; to
cancel): ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf. You must
agree in order to register with the ACME server at
https://acme-v02.api.letsencrypt.org/directory
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(A)gree/(C)ancel: A

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing to share your email address with the Electronic Frontier
Foundation, a founding partner of the Let&#39;s Encrypt project and the non-profit
organization that develops Certbot? We&#39;d like to send you email about our work
encrypting the web, EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: N
</code></pre><p>å®Ÿè¡Œå¾Œã€Cloud DNSä¸Šã‚’ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚<figure><img src=/images/vps-server-setup-with-letsencrypt/2019-03-17-22-59-38.png loading=lazy></figure></p><p>ã†ã¾ãã„ãã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã«ãªã‚‹ã€‚</p><pre tabindex=0><code>IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/fukasawah.dev/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/fukasawah.dev/privkey.pem
   Your cert will expire on 2019-06-15. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   &#34;certbot renew&#34;
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let&#39;s Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
</code></pre><p>ä»¥ä¸‹ã®å ´æ‰€ã«ç”Ÿæˆã•ã‚Œã‚‹ã€‚<code>fukasawah.dev</code>ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³åãªã®ã§å®Ÿè¡Œã™ã‚‹ç’°å¢ƒã§å¤‰ã‚ã‚‹ã€‚</p><ul><li>è¨¼æ˜æ›¸ï¼ˆCAã®ã¿ï¼‰: <code>/etc/letsencrypt/live/fukasawah.dev/chain.pem</code></li><li>è¨¼æ˜æ›¸ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿ï¼‰: <code>/etc/letsencrypt/live/fukasawah.dev/cert.pem</code></li><li>è¨¼æ˜æ›¸ï¼ˆCA+ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰: <code>/etc/letsencrypt/live/fukasawah.dev/fullchain.pem</code></li><li>ç§˜å¯†éµ: <code>/etc/letsencrypt/live/fukasawah.dev/privkey.pem</code></li></ul><p>fullchainã¨privkeyã‚’è‰¯ãä½¿ã†ã“ã¨ã«ãªã‚‹ã¯ãšã€‚</p><p>opensslã‚³ãƒãƒ³ãƒ‰ã§è¨¼æ˜æ›¸ã®å†…å®¹ã‚’è¦—ãã“ã¨ãŒã§ãã‚‹ã€‚</p><pre tabindex=0><code>openssl x509 -text /etc/letsencrypt/live/fukasawah.dev/fullchain.pem
</code></pre><p>ãªãŠã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã•ã‚Œã¦ãŠã‚Šã€å†ç™ºè¡Œ(renew)ã—ã¦ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«é…æ…®ã•ã‚Œã¦ã„ã‚‹ã€‚</p><p>ã¡ãªã¿ã«<code>certbot</code>å®Ÿè¡Œæ™‚ã€TXTãƒ¬ã‚³ãƒ¼ãƒ‰ãŒåæ˜ ã•ã‚Œã‚‹ã¾ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60ç§’å¾…ã¤ã®ã ã‘ã©ã€ãã‚ŒãŒé–“ã«åˆã‚ãªã‹ã£ãŸã®ã‹ä»¥ä¸‹ã®ã‚ˆã†ã«å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã£ãŸã€‚
ãªã®ã§ã€<code>--dns-google-propagation-seconds 120</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¶³ã—ã¦ã„ã‚‹ã€‚</p><pre tabindex=0><code>IMPORTANT NOTES:
 - The following errors were reported by the server:

   Domain: fukasawah.dev
   Type:   unauthorized
   Detail: No TXT record found at _acme-challenge.fukasawah.dev

   To fix these errors, please make sure that your domain name was
   entered correctly and the DNS A/AAAA record(s) for that domain
   contain(s) the right IP address.
 - Your account credentials have been saved in your Certbot
   configuration directory at /etc/letsencrypt. You should make a
   secure backup of this folder now. This configuration directory will
   also contain certificates and private keys obtained by Certbot so
   making regular backups of this folder is ideal.
</code></pre><h3 id=å†ç™ºè¡Œã‚’è©¦ã™>å†ç™ºè¡Œã‚’è©¦ã™</h3><p>æœŸé™ãŒè¿‘ä»˜ã„ã¦ããŸã¨ãã«ã¡ã‚ƒã‚“ã¨è¨¼æ˜æ›¸ãŒæ›´æ–°ã•ã‚Œã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚</p><p>é€šå¸¸ã¯LetsEncryptã®APIã®ãƒªãƒŸãƒƒãƒˆã«ã‹ã‹ã‚‰ãªã„ã‚ˆã†ã«ã€æ‰‹å…ƒã®è¨¼æ˜æ›¸ãŒæœ¬å½“ã«æ›´æ–°ãŒå¿…è¦ã‹ã©ã†ã‹æ¤œè¨¼ã—ã¦ã‹ã‚‰è¡Œã†ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
ãŸã ã€ãã‚Œã ã¨å†è©¦è¡Œã¾ã§æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã†ã®ã§ã€<code>--force-renew</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç„¡ç†ã‚„ã‚Šå†ç™ºè¡Œã™ã‚‹ã€‚</p><pre tabindex=0><code>sudo docker run -it --rm --name certbot \
            -v &#34;/etc/letsencrypt:/etc/letsencrypt&#34; \
            -v &#34;/var/lib/letsencrypt:/var/lib/letsencrypt&#34; \
            -v &#34;/var/log/letsencrypt:/var/log/letsencrypt&#34; \
            certbot/dns-google renew --force-renew
</code></pre><p>ã†ã¾ãã„ã‘ã°ã€<code>ls -l /etc/letsencrypt/archive/*</code>ã§è¨¼æ˜æ›¸ã¨ç§˜å¯†éµãŒå¢—ãˆã¦ã„ã‚‹ã¯ãšã€‚</p><h3 id=cronã§è‡ªå‹•å®Ÿè¡Œã™ã‚‹>cronã§è‡ªå‹•å®Ÿè¡Œã™ã‚‹</h3><p>è‡ªå‹•åŒ–ã™ã‚‹ã¾ã§ãŒãŠä»•äº‹ã§ã™ã€‚ä»Šå›ã¯Cronã‚’ä½¿ã†ã€‚</p><p>cronã§rootãƒ¦ãƒ¼ã‚¶ã§renewã‚’å®šæœŸçš„ã«å®Ÿè¡Œã™ã‚‹</p><pre tabindex=0><code>sudo crontab -e
</code></pre><p>æ¯æ—¥åˆå‰3æ™‚12åˆ†ã«å®Ÿè¡Œã™ã‚‹ã€‚ï¼ˆæ™‚é–“ã¯ãšã‚‰ã™ï¼‰</p><pre tabindex=0><code>12 3 * * * docker run --rm --name certbot -v &#34;/etc/letsencrypt:/etc/letsencrypt&#34; -v &#34;/var/lib/letsencrypt:/var/lib/letsencrypt&#34; -v &#34;/var/log/letsencrypt:/var/log/letsencrypt&#34; certbot/dns-google renew 
</code></pre><h2 id=nginxã®å°å…¥ã¨sslè¨¼æ˜æ›¸ã®åˆ©ç”¨>nginxã®å°å…¥ã¨SSLè¨¼æ˜æ›¸ã®åˆ©ç”¨</h2><p>nginxã®å°å…¥ã¯æ‰‹æŠœã</p><pre tabindex=0><code>sudo yum install nginx
</code></pre><p><code>sudo vi /etc/nginx/nginx.conf</code></p><p>HTTP(tcp/80)ã¯ä½¿ã‚ãªã„ã®ã§ã€ã“ã®éƒ¨åˆ†ã‚’ä¸Šæ›¸ãã—ã¦ã„ãã€‚ã€Œ</p><pre tabindex=0><code>    server {
        listen       80 default_server;
        listen       [::]:80 default_server;

        ...
    }
</code></pre><p>ä»¥ä¸‹ã®ã‚ˆã†ã«ç½®ãæ›ãˆã‚‹ã€‚</p><pre tabindex=0><code>    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;

        # certs sent to the client in SERVER HELLO are concatenated in ssl_certificate
        ssl_certificate /etc/letsencrypt/live/fukasawah.dev/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/fukasawah.dev/privkey.pem;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;
        # modern configuration. tweak to your needs.
        ssl_protocols TLSv1.2;
        ssl_ciphers &#39;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256&#39;;
        ssl_prefer_server_ciphers on;

        # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
        add_header Strict-Transport-Security max-age=15768000;

        # OCSP Stapling ---
        # fetch OCSP records from URL in ssl_certificate and cache them
        ssl_stapling on;
        ssl_stapling_verify on;

        ## verify chain of trust of OCSP response using Root CA and Intermediate certs
        ssl_trusted_certificate /etc/letsencrypt/live/fukasawah.dev/chain.pem;

        server_name  _;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
</code></pre><p>ãªãŠã€ã“ã®å…ƒãƒã‚¿ã¯ä»¥ä¸‹ã‹ã‚‰ç”Ÿæˆã—ã¦ã„ã‚‹ã€‚
<a href=https://mozilla.github.io/server-side-tls/ssl-config-generator/>https://mozilla.github.io/server-side-tls/ssl-config-generator/</a></p><p>ä»¥ä¸‹ã®è¡ŒãŒé•ã†ã ã‘ã§ã€<code>fukasawah.dev</code>ã‚’è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã«ç½®ãæ›ãˆã‚Œã°ã‚ˆã„ã€‚</p><ul><li><code>ssl_certificate</code></li><li><code>ssl_certificate_key</code></li><li><code>ssl_trusted_certificate</code></li></ul><p>è¨­å®šãŒçµ‚ã‚ã£ãŸã‚‰ã€ã‚µãƒ¼ãƒã®èµ·å‹•ãƒ»è‡ªå‹•èµ·å‹•</p><pre tabindex=0><code>systemctl start nginx
systemctl enable nginx

systemctl status nginx
</code></pre><p>https(tcp/443)ã®ãƒãƒ¼ãƒˆã¯ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§å¡ãŒã‚Œã¦ã„ã‚‹ã®ã§ã€firewalldã®è¨­å®šã‚’å¤‰æ›´ã—ã€https(tcp/443)ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹</p><pre tabindex=0><code>firewall-cmd --add-service=https --zone=public 
firewall-cmd --add-service=https --zone=public --permanent
</code></pre><p>Chromeç­‰ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦è¡¨ç¤ºã•ã‚Œã‚Œã°OK</p><p><figure><img src=/images/vps-server-setup-with-letsencrypt/2019-03-17-23-35-31.png loading=lazy></figure></p><p>SSLã®å¦¥å½“æ€§ã‚‚ãƒ†ã‚¹ãƒˆã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚‚è©¦ã™ã€‚
<a href=https://www.ssllabs.com/ssltest/>https://www.ssllabs.com/ssltest/</a></p><p><figure><img src=/images/vps-server-setup-with-letsencrypt/2019-03-17-23-40-44.png loading=lazy></figure></p><p>ã„ã„ã§ã™ã­ã€‚</p><p>ã¡ãªã¿ã«ã€è¨¼æ˜æ›¸ã‚’æ›´æ–°ã—çµ‚ã‚ã£ãŸã‚‰nginxã‚‚reloadã‚’è¡Œã‚ãªã„ã¨åæ˜ ã•ã‚Œãªã„ã€‚ã®ã§ã€<code>systemctl reload nginx</code>ã‚’cronã«å…¥ã‚Œã¦ãŠããªã‚Šã™ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚</p><footer><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://fukasawah.github.io/tags/server>#Server</a></span>
<span class=tag><a href=https://fukasawah.github.io/tags/letsencrypt>#LetsEncrypt</a></span></p><p>Created at: 2019-03-25 02:16 +0900<br>Updated at: 2019-05-27 11:35 +0900 <a href=https://github.com/fukasawah/blog/commit/4e988d9374ed88a1fe3beaedeb6462380649ad85 target=_blank rel=noopener>#4e988d9</a></p><p><a href=https://fukasawah.github.io/posts/2019/03/26/install-postgresql-11-on-centos7/><span title="Install PostgreSQL 11 on CentOS 7">&lt; Next</span></a>
|
<a href=https://fukasawah.github.io/posts/><span title=Posts>Posts</span></a>
|
<a href=https://fukasawah.github.io/posts/2019/01/07/a-part-static-link-in-gnu-ld/><span title="GNU ldã§ä¸€éƒ¨ã‚’ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒªãƒ³ã‚¯ã«ã™ã‚‹">Prev ></span></a></p></footer></article><script src=https://fukasawah.github.io/js/theme-posts.min.526bf4c8dff80bed936c62a06f7bc8c02703fad621e3dd2ba243812d43c40b98397ff1951e5905c790b97c38633d42a0e35bf5314fdf9fcfbce31b18181b8ae3.js integrity="sha512-Umv0yN/4C+2TbGKgb3vIwCcD+tYh490rokOBLUPEC5g5f/GVHlkFx5C5fDhjPUKg41v1MU/fn8+84xsYGBuK4w==" defer></script></main><footer><p>&copy; 2024 <a href=https://fukasawah.github.io/>fukasawah</a></p></footer></body></html>