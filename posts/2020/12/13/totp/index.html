<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/theme.min.95e92366236e3eeadc2635f8c1c7b97ec3640de0147fa10ee1d281d56d40ee1aeb2c76977676599f543a2a682fd96d8cb9633a4fc700e537e46f8ba9d58df9f2.css integrity="sha512-lekjZiNuPurcJjX4wce5fsNkDeAUf6EO4dKB1W1A7hrrLHaXdnZZn1Q6Kmgv2W2MuWM6T8cA5Tfkb4up1Y358g=="><link rel=stylesheet href=https://fukasawah.github.io/css/syntax.min.9d0044b0ce135aff3405271be2a17805c5ae03ec48f146191dc4b30923424c76fe7c6086323aa2cbf83affd41e11fef907f33b6cd685fe3645043bb79f63509a.css integrity="sha512-nQBEsM4TWv80BScb4qF4BcWuA+xI8UYZHcSzCSNCTHb+fGCGMjqiy/g6/9QeEf75B/M7bNaF/jZFBDu3n2NQmg==" media=print onload='this.media="all"'><noscript><link rel=stylesheet type=text/css href=https://fukasawah.github.io/css/syntax.min.9d0044b0ce135aff3405271be2a17805c5ae03ec48f146191dc4b30923424c76fe7c6086323aa2cbf83affd41e11fef907f33b6cd685fe3645043bb79f63509a.css integrity="sha512-nQBEsM4TWv80BScb4qF4BcWuA+xI8UYZHcSzCSNCTHb+fGCGMjqiy/g6/9QeEf75B/M7bNaF/jZFBDu3n2NQmg=="></noscript><title>ワンタイムパスワードのTOTPを少し調べた | fukasawah.github.io</title></head><body><header><p><a href=https://fukasawah.github.io/>fukasawah.github.io</a></p></header><main><article><header><h1>ワンタイムパスワードのTOTPを少し調べた</h1></header><p>ワンタイムパスワード（OTP）のTOTPについて調べた。</p><p>ワンタイムパスワードは２段階認証をやったりするときに使う。何気なく使ってたけど、これどうやって実装するんだろう？と思っていたので感覚をつかみたかった。</p><h2 id=totptime-based-one-time-password>TOTP(Time-Based One-Time Password)</h2><h3 id=概要>概要</h3><p>TOTPはTime-Based One-Time Password の略でOTPの実装の一つ。RFC 6238で決まってる。</p><p><a href=https://tools.ietf.org/html/rfc6238>https://tools.ietf.org/html/rfc6238</a></p><p>秘密鍵を事前に共有して、秘密鍵と時間に基づいたコードを生成し、それをワンタイムパスワードとして使う。</p><h3 id=何をすればよいか>何をすればよいか</h3><p>ユーザ側はコードを生成するためのアプリを用意する必要がある。Google AuthenticatorやMicrosoft Authenticatorとか。</p><p>サービス側は秘密鍵の保持と検証するためにコードを生成と比較をする必要がある。</p><h3 id=コードの生成の仕方>コードの生成の仕方</h3><p>まず、秘密鍵を決める必要があるが、BASE32に基づいた値であればなんでもよい。BASE32は人が読みやすい値を採用した符号化方式。
なので、乱数で適当にバイナリ列を生成してBASE32に変換した値をユーザ毎に生成すればよい。（もちろん他の人が推測できないような乱数を使うようにしましょう。）</p><p>コードの生成は参照実装がRFCに書かれているが、たいていはライブラリがあるのでそれを利用すると簡単。
「TOTP 言語」で調べればそれっぽいライブラリが出てくる。
やることは秘密鍵と時間を基にコードを生成するだけなので、参照実装を読み解けば実装はできるはず（今回はやらない&mldr;）</p><h3 id=アプリと連携したい>アプリと連携したい</h3><p>RFCに従いアプリを作ればいいだけではありますが、アプリを作るのは大変なので、既存のものに乗っかるほうがよいでしょう。
有名なところでは、スマートフォンアプリにGoogle AuthenticatorやMicrosoft Authenticatorとかがある。WindowsであればWinAuthでも動作する。</p><p>最低限、秘密鍵の入力が出来れば連携は可能。</p><h3 id=アプリで読み取れるqrコードを生成したい>アプリで読み取れるQRコードを生成したい</h3><p>QRコード自体は「データ」をコンピュータで読み取れる画像で表現するだけのものなので、ここでは深くは触れない（QRコード内にロゴを入れたいとか色々あると思う。）</p><p>で、どういった「データ」を埋め込むかは、「URI形式でotpauth スキームに従った値」となる。</p><p>ただ、otpauthスキームは標準化されていないようで、アプリの動作による模様。残念。</p><p>Google AuthenticatorやMicrosoft Authenticatorについて調べた。</p><p>Google Authenticator は以下でまとまっている。
<a href=https://github.com/google/google-authenticator/wiki/Key-Uri-Format>https://github.com/google/google-authenticator/wiki/Key-Uri-Format</a></p><p>Microsoft Authenticatorはotpauthスキームはサポートしているが、明確な資料がなさそう。</p><p>Google AuthenticatorとMicrosoft Authenticatorのクエリパラメータの挙動の違いを見てみたが、secret以外のクエリパラメータは無視する模様。</p><table><thead><tr><th></th><th>Google</th><th>Microsoft</th></tr></thead><tbody><tr><td>secret</td><td>〇</td><td>〇</td></tr><tr><td>digits</td><td>〇</td><td>×(6)</td></tr><tr><td>algorithm</td><td>〇</td><td>×(SHA1)</td></tr><tr><td>period</td><td>〇</td><td>×(30)</td></tr><tr><td>issuer</td><td>〇</td><td>×</td></tr></tbody></table><p>カッコ内の数値はGoogleを基準にしたときに相当する値で、同じURIで両方のアプリをサポートしたいといった最大公約数的な考え方で行くと、SHA1で、6桁で、30秒としないといけない。</p><p>また、ISSUERについても、Googleはクエリパラメータのissuerを表示するが、MicrosoftはラベルのほうのISSUERを表示する。</p><p>というわけで、以下のような形になればよい。</p><p><code>"otpauth://totp/ISSUER:USER?secret=SECRET&issuer=ISSUER</code></p><p>（Googleのほうは、クエリパラメータのissuerとラベルのISSUERが一致するとラベルのほうのISSUERが省略されるが、一致しないとラベルのほうのISSUERが省略されないといった感じになる。まぁissuerの値は一緒にしておきましょうということ。）</p><h2 id=pythonによる実装>Pythonによる実装</h2><p>コードはいかにまとめました。</p><p><a href=https://github.com/fukasawah/python-totp-example>https://github.com/fukasawah/python-totp-example</a></p><h3 id=秘密鍵の生成>秘密鍵の生成</h3><p>やり方はなんでもいいです。ちなみに長さが5の倍数(byte)だとpaddingの削除が不要になります。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py:generate-key.py data-lang=py:generate-key.py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>LEN</span><span class=o>=</span><span class=mi>20</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>random</span><span class=o>.</span><span class=n>getrandbits</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>LEN</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data_base32_str</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b32encode</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>data_base32_str</span><span class=p>)</span>
</span></span></code></pre></div><p>こんな感じに使い、BASE32の秘密鍵を生成します</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python generate-key.py
</span></span><span class=line><span class=cl><span class=c1># =&gt; B3DQULIS7BASNVU2ZLYTZGU4NU7YNVF5</span>
</span></span></code></pre></div><h3 id=qrコード生成>QRコード生成</h3><p>QRコード生成には<code>qrcode</code>を用います。</p><p><a href=https://pypi.org/project/qrcode/>https://pypi.org/project/qrcode/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py:qrcode-generate.py data-lang=py:qrcode-generate.py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>qrcode</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>urllib.parse</span> <span class=kn>import</span> <span class=n>quote</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 手元で試すだけなので、引数で決める</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;required argument&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=n>SECRET_KEY_BASE32</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>USER</span> <span class=o>=</span> <span class=s2>&#34;example@dummy.local&#34;</span>
</span></span><span class=line><span class=cl><span class=n>ISSUER</span> <span class=o>=</span> <span class=s2>&#34;EXAMPLE&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>uri</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;otpauth://totp/</span><span class=si>{</span><span class=n>quote</span><span class=p>(</span><span class=n>ISSUER</span><span class=p>)</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>quote</span><span class=p>(</span><span class=n>USER</span><span class=p>)</span><span class=si>}</span><span class=s2>?secret=</span><span class=si>{</span><span class=n>SECRET_KEY_BASE32</span><span class=si>}</span><span class=s2>&amp;issuer=</span><span class=si>{</span><span class=n>quote</span><span class=p>(</span><span class=n>ISSUER</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 後述するpyotpを使う場合は以下のようにしても同様のURIが得られる</span>
</span></span><span class=line><span class=cl><span class=c1># import pyotp</span>
</span></span><span class=line><span class=cl><span class=c1># totp = pyotp.TOTP(SECRET_KEY_BASE32)</span>
</span></span><span class=line><span class=cl><span class=c1># uri = totp.provisioning_uri(name=USER, issuer_name=ISSUER)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 画像を生成(PILImageオブジェクトが得られる)</span>
</span></span><span class=line><span class=cl><span class=n>image</span> <span class=o>=</span> <span class=n>qrcode</span><span class=o>.</span><span class=n>make</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 画像を保存</span>
</span></span><span class=line><span class=cl><span class=n>image</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=s2>&#34;qrcode.png&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>こんな感じに使うと、&ldquo;qrcode.png"が生成されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python qrcode-generate.py B3DQULIS7BASNVU2ZLYTZGU4NU7YNVF5
</span></span></code></pre></div><p>出来上がったQRコードをアプリで取り込んでみましょう。</p><h3 id=検証するコード>検証するコード</h3><p>pyotpを使います。</p><p><a href=https://pypi.org/project/pyotp/>https://pypi.org/project/pyotp/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python:totp-example.py data-lang=python:totp-example.py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyotp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 手元で試すだけなので、引数で決める</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;required argument&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SECRET_KEY_BASE32</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># インスタンス生成</span>
</span></span><span class=line><span class=cl><span class=n>totp</span> <span class=o>=</span> <span class=n>pyotp</span><span class=o>.</span><span class=n>TOTP</span><span class=p>(</span><span class=n>SECRET_KEY_BASE32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定期的にコードが更新されることを確認する</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=n>prev_code</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=n>totp</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>  <span class=c1># ワンタイムパスワードを得る</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>prev_code</span> <span class=o>==</span> <span class=n>code</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prev_code</span> <span class=o>=</span> <span class=n>code</span>
</span></span></code></pre></div><p>こんな感じに使うと、コンソールにもワンタイムパスワードが表示されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python totp-example.py B3DQULIS7BASNVU2ZLYTZGU4NU7YNVF5
</span></span></code></pre></div><p>アプリ側の表示と、検証コードで表示されるコードが一致するはずです。</p><p>なので、実際は以下のようになります。</p><ul><li>ユーザ: アプリに表示されたコードを入力してサービス側に送信する</li><li>サービス: <code>totp.now()</code>で得られたコードと、ユーザが送信したコードが一致するかを検証する</li></ul><h2 id=その他>その他</h2><h3 id=winauth-windows上で動作するtotp対応アプリ>Winauth: Windows上で動作するTOTP対応アプリ</h3><p>スマートフォンでしか動作確認していなかったが、Windows上で確認するためのアプリが無いか探したら「Winauth」があった。</p><p><a href=https://github.com/winauth/winauth>https://github.com/winauth/winauth</a></p><p>「Support for time-based RFC 6238 authenticators (e.g. Google Authenticator) and HOTP counter-based authenticators」とあるので対応している</p><p>exeをダウンロードして起動したら以下の手順で追加する。</p><ul><li>Add→「Authenticator」を選択</li><li>秘密鍵を入力する箇所があるので、秘密鍵を入力</li><li>Time-basedを選択する</li><li>「Verify Authenticator」 をクリックして表示されるコードを確認</li></ul><p><figure><img src=./images/index/2020-12-14-00-26-33.png loading=lazy></figure></p><h2 id=おわり>おわり</h2><p>実際に動くWebアプリを作ったり、TOTP用の秘密鍵はどう扱えばよいのか、他の方式(HOTP)の優劣とか使い分けとか、どんなときにワンタイムパスワードを要求するのかとかもう少し調べるところはありそう。</p><p>ワンタイムパスワードも面倒なのでデバイス認証にしたい場合とかも気になる。FIDO U2Fとか。</p><footer><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://fukasawah.github.io/tags/%E3%83%AF%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89>#ワンタイムパスワード</a></span>
<span class=tag><a href=https://fukasawah.github.io/tags/%E8%AA%8D%E8%A8%BC>#認証</a></span></p><p>Created at: 2020-12-13 22:06 +0900<br>Updated at: 2020-12-14 00:28 +0900 <a href=https://github.com/fukasawah/blog/commit/ba8a49f3f4d47c20f834f4b3c187813f09f0ca60 target=_blank rel=noopener>#ba8a49f</a></p><p><a href=https://fukasawah.github.io/posts/2021/04/22/hugo-markdown-render-hooks/><span title=Hugoのmarkdown-render-hooksのメモ>&lt; Next</span></a>
|
<a href=https://fukasawah.github.io/posts/><span title=Posts>Posts</span></a>
|
<a href=https://fukasawah.github.io/posts/2020/06/25/live-camera-on-the-raspberrypi-ffmpeg/><span title=" Raspberry Pi + ffmpegでライブカメラ">Prev ></span></a></p></footer></article><script src=https://fukasawah.github.io/js/theme-posts.min.526bf4c8dff80bed936c62a06f7bc8c02703fad621e3dd2ba243812d43c40b98397ff1951e5905c790b97c38633d42a0e35bf5314fdf9fcfbce31b18181b8ae3.js integrity="sha512-Umv0yN/4C+2TbGKgb3vIwCcD+tYh490rokOBLUPEC5g5f/GVHlkFx5C5fDhjPUKg41v1MU/fn8+84xsYGBuK4w==" defer></script></main><footer><p>&copy; 2024 <a href=https://fukasawah.github.io/>fukasawah</a></p></footer></body></html>